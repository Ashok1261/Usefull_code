import pandas as pd
import psycopg2
from sqlalchemy import create_engine, inspect

# Step 1: Load the CSV file
file = 'your_file.csv'  # üîÅ Update path
df = pd.read_csv(file)

# Optional: truncate long strings
max_length = 255
for col in df.select_dtypes(include='object').columns:
    df[col] = df[col].astype(str).str.slice(0, max_length)

# Step 2: DB connection details
username = ''
password = ''
host = ''
port = ''
database = ''
table_name = ''
primary_key_column = ''  # üîÅ Replace with your actual PK column

# Step 3: Create connections
engine = create_engine(f'postgresql://{username}:{password}@{host}:{port}/{database}')
conn = psycopg2.connect(host=host, port=port, dbname=database, user=username, password=password)
cursor = conn.cursor()

# Step 4: Get existing columns from the target table
inspector = inspect(engine)
pg_columns = [col['name'] for col in inspector.get_columns(table_name)]

# Step 5: Update rows
updated_rows = 0
for _, row in df.iterrows():
    pk_value = row.get(primary_key_column)
    if pd.isnull(pk_value):
        continue  # Skip if no primary key

    update_fields = []
    values = []

    for col in df.columns:
        if col in pg_columns and col != primary_key_column:
            val = row[col]
            if pd.notnull(val):
                update_fields.append(f'"{col}" = %s')
                values.append(val)

    if update_fields:
        update_sql = f'''
            UPDATE "{table_name}"
            SET {', '.join(update_fields)}
            WHERE "{primary_key_column}" = %s
        '''
        values.append(pk_value)

        try:
            cursor.execute(update_sql, values)
            updated_rows += 1
        except Exception as e:
            print(f"‚ùå Error updating row with {primary_key_column}={pk_value}: {e}")

# Step 6: Commit and close
conn.commit()
cursor.close()
conn.close()
print(f"‚úÖ Successfully updated {updated_rows} row(s).")
