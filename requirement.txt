
import pandas as pd
import io
import logging
from ssrai.blob.blob_file_path import BlobLocation
from services.data_curation_service import DataCurationService

logger = logging.getLogger(__name__)

def save_evaluation_results_to_blob(df: pd.DataFrame, filename: str) -> str:
    """
    Save evaluation results to blob and return only the string blob path.
    Avoid returning StorageObj to prevent JSON serialization errors.
    """
    try:
        csv_buffer = io.StringIO()
        df.to_csv(csv_buffer, index=False)

        # Call upload
        response = DataCurationService().upload_file_blob(
            csv_buffer.getvalue(),
            filename="evaluation.csv",
            blobFilePath=BlobLocation(container_name="pvt-markets", absolute_path=filename)
        )

        # Check response and extract the string path
        if isinstance(response, dict) and "storagePath" in response:
            return response["storagePath"]

        if hasattr(response, "message") and isinstance(response.message, str):
            return response.message

        # Fallback string if nothing works
        return filename

    except Exception as e:
        logger.error(f"Error saving results to blob: {e}", exc_info=True)
        return ""
