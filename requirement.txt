
import os
import io
import json
import zipfile
import logging
from fastapi import UploadFile
from datetime import datetime
from common_svc.utils.blob_utils import get_strategy_storage_path  # adjust to your actual import
from fts_mgmt.models.response_models import EvaluationResponse  # adjust if needed
from fts_commons.models.evaluation_models import EvalConfig  # adjust if needed

logger = logging.getLogger(__name__)

ALLOWED_COMPRESSIONS = ["application/zip", "application/x-zip-compressed"]

async def create_evaluation_strategy(self, name: str, description: str, strategyFile: UploadFile):
    strategy_id = generate_unique_number()
    strategy_config = None

    try:
        file_bytes = await strategyFile.read()

        # Ensure it's a zip
        if strategyFile.content_type not in ALLOWED_COMPRESSIONS:
            raise Exception("Only ZIP format is supported for strategy upload.")

        storage_path = get_strategy_storage_path(strategy_id=strategy_id, strategy_name=name)

        with zipfile.ZipFile(io.BytesIO(file_bytes), mode="r") as zip_file:
            for member in zip_file.infolist():
                with zip_file.open(member) as file_data:
                    abs_path = os.path.join(storage_path, member.filename)

                    # Save file to blob
                    self.blob_service.save_file(file_data=file_data, blob_absolute_path=abs_path)

                    file_data.seek(0)  # Reset pointer

                    # If it's a config JSON
                    if member.filename.endswith(".json") and "config" in member.filename.lower():
                        strategy_config = json.load(file_data)
                        logger.info(f"Loaded config from {member.filename}")

                    # If it's a CSV file
                    elif member.filename.endswith(".csv"):
                        # Optionally: validate CSV here
                        strategy_config = strategy_config or {}
                        strategy_config['eval_strategy_blob_path'] = abs_path
                        logger.info(f"CSV path set in config: {abs_path}")

        if not strategy_config:
            raise Exception("No valid config JSON file found in the ZIP.")

        # Save strategy to DB
        self.evaluation_dao.save_evaluation_strategy(
            strategy_id=strategy_id,
            name=name,
            description=description,
            config=strategy_config,
            created_by=self.user_model.userId
        )

        # Retrieve to return response
        strategy = self.evaluation_dao.get_evaluation_strategy_by_id(strategy_id)

        return EvaluationResponse(
            evalStrategyId=strategy.id,
            evalStrategyName=strategy.name,
            evalStrategydescription=strategy.description,
            evalstrategyConfig=EvalConfig(**strategy.config),
            createdBy=strategy.created_by,
            modifiedBy=strategy.modified_by,
            createdTs=strategy.created_ts,
            modifiedTs=strategy.modified_ts
        )

    except Exception as e:
        logger.error(f"Exception in creating evaluation strategy: {e}", exc_info=True)
        raise Exception(str(e))





Implemented Evaluation Metrics Management APIs

Create API – To save new evaluation strategies and configurations

Update API – To modify existing evaluation metric strategies

Delete API – To remove unwanted or obsolete evaluation strategies

Download API – To export evaluation metric results or strategies

Trigger API – To initiate evaluation metrics execution using defined strategy and ECS ID


import sys
import os

sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '../../../')))
